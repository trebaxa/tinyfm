var fm={defaults:[["server","/"],["data",null],["akey",""],["target","#js-fm-main"],["field_id",""],["functions",[["on_fm_delete_request",""],["on_upload",""],["on_delete",""],["on_rename",""]]]],options:{},server:"",load_folder:function(element){var jsonstr=element.getAttribute("data-info");this.request("load_folder",jsonstr,this.options.target)},reload_folder:function(){this.request("reload_folder","",this.options.target)},loadscript:function(url,t){this.ajax(url,t)},request:function(c,j,t){this.killtooltip();var url=fm.server+"cmd="+c+"&json="+j;this.ajax(url,t)},toggle_upload:function(){$("#js-dropzone").slideToggle()},update_options:function(_opt){var opt=$.merge(this.defaults,_fm);var opt=$.merge(opt,_opt);this.options=Object.fromEntries(opt);this.options.functions=Object.fromEntries(this.options.functions)},upload_finished:function(file,ident){if(Array.isArray(this.options.functions)){this.options.functions=Object.fromEntries(this.options.functions)}if(this.options.functions.on_upload!=""){var func=this.options.functions.on_upload+'("'+file+'","'+ident+'")';eval(func)}},ajax:function(url,t){url=url+"&akey="+this.options.akey;this.killtooltip();$.ajax({url:url,cache:false,success:function(html){$(t).fadeOut("fast",function(){$(t).html(html);$(t).fadeIn()})}})},close:function(){$("#js-tools").fadeOut("fast",function(){$("#js-tools").html("");$("#js-tools").show()})},show_saved_msg:function(duration){if(duration==""||duration==0||duration==null)duration=3e3;$("#statusinfo").hide();$("#savedresult").css("position","fixed");$("#savedresult").css("z-index","1066");$("#savedresult").css("top","50%");$("#savedresult").css("left","50%");$("#savedresult").css("transform","translate(-50%, -50%)");$("#savedresult").addClass("p-3");$("#savedresult").fadeIn();setTimeout('$("#savedresult").fadeOut();',duration)},show_json_answer:function(data){var obj=jQuery.parseJSON(data);$("#savedresult").remove();$("body").prepend('<div id="savedresult"></div>');if(obj.msge!=""){$("#savedresult").html(obj.msge);$("#savedresult").removeClass("alert-success").addClass("alert-danger");this.show_saved_msg(6e3)}else{$("#savedresult").removeClass("alert-danger").addClass("alert-success");$("#savedresult").html(obj.msg);this.show_saved_msg(6e3);if(obj.jsfunction!=""){eval(obj.jsfunction+"("+obj.jsparams+")")}$("input[type=file]").val("")}},killtooltip:function(){$('[data-bs-toggle="tooltip"]').tooltip("hide");$(".tooltip").remove()},apply_file:function(url,element,localfile){window.parent.postMessage({cmd:"apply_file",sender:"tinyfm",hash:element.data("hash"),url:url,localfile:localfile,field_id:this.options.field_id},"*")},show_dropzone:function(){var mouseOverTarget=document.getElementById("fm-files");fm.toggle_upload();mouseOverTarget.removeEventListener("dragenter",fm.show_dropzone,true)},init_drag:function(){var mouseOverTarget=document.getElementById("fm-files");mouseOverTarget.removeEventListener("dragenter",fm.show_dropzone,true);mouseOverTarget.addEventListener("dragenter",fm.show_dropzone,true)},mass_del:function(){var hashes=ids=new Array;$(".js-file-checkbox:checked").each(function(){var b=$(this).closest(".js-fm-card");ids.push(b.data("ident"));hashes.push(b.data("hash"))});if(fm.options.functions.on_fm_delete_request!=""){hashes.push(obj.hash);var func=fm.options.functions.on_fm_delete_request+"('"+JSON.stringify(hashes)+"')";eval(func);if(fm.options.data.found>0){alertify.alert(fm.options.data.msge).setting("title","Declined");return false}}var url=fm.server+"&cmd=mass_del&ids="+JSON.stringify(ids);alertify.defaults.glossary.title="Confirm";alertify.confirm("really delete?",function(ev){$.getJSON(url,function(data){if(data.msge==""){}fm.show_json_answer(JSON.stringify(data))});$(".js-file-checkbox:checked").each(function(){$(this).closest(".js-fm-card").fadeTo(100,0,function(){$(this).remove()})})},function(ev){})},on_rename:function(ident,new_ident,file){if(Array.isArray(fm.options.functions)){fm.options.functions=Object.fromEntries(fm.options.functions)}if(fm.options.functions.on_rename!=""){var func=fm.options.functions.on_rename+'("'+ident+'","'+new_ident+'","'+file+'")';eval(func)}},scrollto:function(ident){$("html, body").stop().animate({scrollTop:$(ident).offset().top-90},900,"swing",function(){})},init:function(){console.clear();var opt=$.merge(this.defaults,_fm);this.options=Object.fromEntries(opt);this.server=this.options.server+"fm.php?akey="+this.options.akey+"&";var fm=this;if(this.options.server==""){console.error("server variable not set");console.log("your settings",this.options)}fm.init_drag();$(".js-link").unbind("click");$(".js-link").click(function(e){e.preventDefault();fm.loadscript($(this).attr("href"),$(this).data("target"))});$(".js-file-checkbox").unbind("click");$(".js-file-checkbox").click(function(e){if($(this).prop("checked")){$(this).closest(".js-fm-card").find(".image:first").addClass("fm-checked")}else{$(this).closest(".js-fm-card").find(".image:first").removeClass("fm-checked")}if($(".js-file-checkbox:checked").length>0){$("#js-mass-del-icon").fadeIn()}else{$("#js-mass-del-icon").fadeOut()}});$(".js-rename-file").unbind("click");$(".js-rename-file").click(function(e){e.preventDefault();var btn=$(this);alertify.defaults.glossary.title="Confirm";alertify.prompt("new filename",btn.data("filename"),function(ev,value){var url=fm.server+"&cmd=rename_file&v="+value+"&ident="+JSON.stringify(btn.data("info"));$.getJSON(url,function(data){if(data.msge==""){fm.reload_folder()}fm.show_json_answer(JSON.stringify(data))})},function(ev){})});$(".js-dir-file").unbind("click");$(".js-dir-file").click(function(e){e.preventDefault();var btn=$(this);alertify.defaults.glossary.title="Confirm";alertify.prompt("new dir name",btn.data("filename"),function(ev,value){var url=fm.server+"&cmd=rename_dir&v="+value+"&ident="+JSON.stringify(btn.data("info"));$.getJSON(url,function(data){if(data.msge==""){fm.reload_folder()}fm.show_json_answer(JSON.stringify(data))})},function(ev){})});$(".js-del-link").unbind("click");$(".js-del-link").click(function(e){e.preventDefault();var btn=$(this);if(Array.isArray(fm.options.functions)){fm.options.functions=Object.fromEntries(fm.options.functions)}if(fm.options.functions.on_fm_delete_request!=""){var obj=JSON.parse(JSON.stringify(btn.data("info")));var hashes=[];hashes.push(obj.hash);var func=fm.options.functions.on_fm_delete_request+"('"+JSON.stringify(hashes)+"')";eval(func);if(fm.options.data.found>0){var str="<br>";fm.options.data.found_table.forEach(function(item){str=str+item.label+"<br>"});alertify.alert(fm.options.data.msge+str).setting("title","Declined");return false}}alertify.defaults.glossary.title="Confirm";alertify.confirm("really delete?",function(ev){var url=fm.server+"&cmd="+btn.data("cmd")+"&ident="+JSON.stringify(btn.data("info"));$.getJSON(url,function(data){if(data.msge==""){btn.closest(".js-fm-card").fadeTo(100,0,function(){$(this).remove()});if(fm.options.functions.on_delete!=""){var obj=JSON.parse(JSON.stringify(btn.data("info")));var func=fm.options.functions.on_delete+'("'+obj.hash+'")';eval(func)}}fm.show_json_answer(JSON.stringify(data))})},function(ev){})});$(".card-hover").hover(function(){$(this).find(".overlay:first").fadeIn("fast")},function(){$(this).find(".overlay:first").fadeOut("fast")}),$(".js-fm-filter").unbind("click");$(".js-fm-filter").click(function(e){e.preventDefault();var filter=$(this).data("type");if($(this).hasClass("active")){$('input[name="FORM[types]['+filter+']"]').val("0");$(this).removeClass("active")}else{$('input[name="FORM[types]['+filter+']"]').val("1");$(this).addClass("active")}$('input[name="FORM[types]['+filter+']"]').closest("form").trigger("submit");fm.killtooltip()});$(".js-fm-view").unbind("click");$(".js-fm-view").click(function(e){e.preventDefault();$('input[name="FORM[view]"]').val($(this).data("view"));$('input[name="FORM[view]"]').closest("form").trigger("submit");fm.killtooltip()});$(".js-single-select").unbind("click");$(".js-single-select").click(function(e){e.preventDefault();fm.killtooltip();var b=$(this).closest(".js-fm-card");var a=b.data("function");fm[a](b.data("url"),b,b.data("localfile"))});$(".json-form").unbind("submit");$(".json-form").submit(function(e){e.preventDefault();var form=$(this);var url=form.attr("action");$("#akey").remove();var i=document.createElement("input");i.type="hidden";i.id="akey";i.name="akey";i.value=fm.options.akey;form.append(i);$.ajax({type:"POST",url:url,data:form.serialize(),success:function(data){fm.show_json_answer(data)}})});$(".ax-form").unbind("submit");$(".ax-form").submit(function(e){e.preventDefault();fm.killtooltip();var form=$(this);var url=form.attr("action");var target=$(this).data("target");$("#akey").remove();var i=document.createElement("input");i.type="hidden";i.id="akey";i.name="akey";i.value=fm.options.akey;form.append(i);$.ajax({type:"POST",url:url,data:form.serialize(),success:function(data){$(target).html(data)}})});var tooltipTriggerList=[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));var tooltipList=tooltipTriggerList.map(function(tooltipTriggerEl){return new bootstrap.Tooltip(tooltipTriggerEl)})}};jQuery(function(){fm.init()});
